const _trilogyt._created_at <- current_datetime();

import store_sales as store_sales;

rowset su <- WHERE
    store_sales.store.market = 8 and (store_sales.customer.birth_country != upper(store_sales.customer.country) and (store_sales.is_returned is True and store_sales.store.zip = store_sales.customer.zip))
SELECT
    --store_sales.customer.id,
    --store_sales.item.id,
    --store_sales.store.id,
    store_sales.customer.first_name,
    store_sales.customer.last_name,
    store_sales.store.name,
    store_sales.item.color,
    sum(store_sales.net_paid) -> net_paid,
;

metric avg_store_customer_sales <- avg(su.net_paid) by __preql_internal.all_rows;

SELECT
    su.store_sales.customer.last_name,
    su.store_sales.customer.first_name,
    su.store_sales.store.name,
    --avg_store_customer_sales,
    sum(filter su.net_paid where su.store_sales.item.color = 'peach') -> peach_sales,
HAVING
    peach_sales > 0.05 * avg_store_customer_sales

;