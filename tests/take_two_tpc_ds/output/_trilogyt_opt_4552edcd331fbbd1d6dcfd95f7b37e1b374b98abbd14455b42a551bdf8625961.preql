const _trilogyt._created_at <- current_datetime();

import store_returns as returns;

WHERE
    returns.store.state = 'TN' and returns.return_date.year = 2000
SELECT
    returns.customer.text_id,
    --sum(returns.return_amount) -> total_returns,
    --returns.store.id,
    --avg(total_returns) by returns.store.id -> avg_store_returns,
HAVING
    total_returns > (1.2 * avg_store_returns)

ORDER BY
    returns.customer.text_id asc
LIMIT 100
;

PERSIST default.dsa09b549514982e2f5ebaf23a4352f002a4259c548b06c2eac32969c3a097f293_filtered_on_state_year INTO dsa09b549514982e2f5ebaf23a4352f002a4259c548b06c2eac32969c3a097f293_filtered_on_state_year FROM WHERE
    returns.store.state = 'TN' and returns.return_date.year = 2000
SELECT
    returns.customer.text_id,
    returns.item.id,
    returns.return_amount,
    returns.store.id,
    returns.store_sales.ticket_number,
;

PERSIST default.ds076b41e98d63ade6d76668df39d060a23d05937779557c564c9c9741a7ecc775 INTO ds076b41e98d63ade6d76668df39d060a23d05937779557c564c9c9741a7ecc775 FROM SELECT
    total_returns,
    returns.customer.text_id,
    returns.store.id,
;

PERSIST default.ds54404a332ea8db7d5077c55e8dfb983a19e81172a43fe2d05f56910f96fbd12f INTO ds54404a332ea8db7d5077c55e8dfb983a19e81172a43fe2d05f56910f96fbd12f FROM SELECT
    avg_store_returns,
    returns.store.id,
;

PERSIST default.dsbc912b25ff1ee9ff54c1121741e6d5b7272334fa87fbe928ab53906b3dfaeb77_filtered_on_total_returns_avg_store_returns INTO dsbc912b25ff1ee9ff54c1121741e6d5b7272334fa87fbe928ab53906b3dfaeb77_filtered_on_total_returns_avg_store_returns FROM WHERE
    total_returns > (1.2 * avg_store_returns)
SELECT
    returns.customer.text_id,
    total_returns,
    returns.store.id,
    avg_store_returns,
;