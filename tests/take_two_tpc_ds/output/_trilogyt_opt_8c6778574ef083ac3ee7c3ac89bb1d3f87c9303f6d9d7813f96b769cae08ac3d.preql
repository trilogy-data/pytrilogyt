const _trilogyt._created_at <- current_datetime();

import store_sales as store_sales;

import item as item;

MERGE store_sales.item.id into item.id;

WHERE
    store_sales.date.year = 2001 and (store_sales.date.month_of_year = 1 and (store_sales.item.current_price > 1.2 * avg(item.current_price) by item.category and store_sales.item.category is not null))
SELECT
    store_sales.customer.state,
    sum(group(1) by store_sales.ticket_number, item.id) -> customer_count,
HAVING
    customer_count >= 10

ORDER BY
    customer_count asc nulls first,
    store_sales.customer.state asc nulls first
;

PERSIST default.ds8c6c8978eceb3584f81ac590cad3936069fc052bd8d9547b86ce269e768dab5c_filtered_on_year_month_of_year_category INTO ds8c6c8978eceb3584f81ac590cad3936069fc052bd8d9547b86ce269e768dab5c_filtered_on_year_month_of_year_category FROM WHERE
    (store_sales.date.year = 2001 and store_sales.date.month_of_year = 1) and store_sales.item.category is not null
SELECT
    item.category,
    item.id,
    store_sales.customer.state,
    store_sales.date.month_of_year,
    store_sales.date.year,
    store_sales.item.category,
    store_sales.item.current_price,
    store_sales.ticket_number,
;

PERSIST default.ds380d56b7ad4c42e4c565b685188f9732c530e99b7c4ac874b668c8b5ce9d403f_filtered_on_year_month_of_year_current_price_virtual_category INTO ds380d56b7ad4c42e4c565b685188f9732c530e99b7c4ac874b668c8b5ce9d403f_filtered_on_year_month_of_year_current_price_virtual_category FROM WHERE
    store_sales.date.year = 2001 and (store_sales.date.month_of_year = 1 and (store_sales.item.current_price > 1.2 * _virt_agg_avg_5942253052406187 (not found in environment) and store_sales.item.category is not null))
SELECT
    item.id,
    store_sales.ticket_number,
    store_sales.customer.state,
;

PERSIST default.ds1ade888f9d2a2866f34700c85b5043ed154fe4b50449c73f940540187f2035da INTO ds1ade888f9d2a2866f34700c85b5043ed154fe4b50449c73f940540187f2035da FROM SELECT
    store_sales.ticket_number,
    item.id,
    store_sales.customer.state,
;

PERSIST default.dsca3b5a51d14fcbd40d5c6c4925c0746c19cb4a6d55f2ac9c8f882233c8276003_filtered_on_customer_count INTO dsca3b5a51d14fcbd40d5c6c4925c0746c19cb4a6d55f2ac9c8f882233c8276003_filtered_on_customer_count FROM WHERE
    customer_count >= 10
SELECT
    store_sales.customer.state,
    customer_count,
;