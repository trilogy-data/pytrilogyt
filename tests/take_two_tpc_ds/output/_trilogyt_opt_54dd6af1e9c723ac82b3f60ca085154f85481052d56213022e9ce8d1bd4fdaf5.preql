const _trilogyt._created_at <- current_datetime();

import store_sales as store_sales;

import catalog_sales as catalog_sales;

rowset merged <- WHERE
    store_sales.date.month_seq >= 1200 and store_sales.date.month_seq <= 1200 + 11
SELECT
    store_sales.customer.id,
    store_sales.item.id,
    --store_sales.date.month_seq,
MERGE
WHERE
    catalog_sales.date.month_seq >= 1200 and catalog_sales.date.month_seq <= 1200 + 11
SELECT
    catalog_sales.bill_customer.id,
    catalog_sales.item.id,
    --catalog_sales.date.month_seq,
ALIGN
	customer_id:store_sales.customer.id,catalog_sales.bill_customer.id,
	item_id:store_sales.item.id,catalog_sales.item.id
;

SELECT
    sum(CASE WHEN (merged.store_sales.customer.id is not null and merged.catalog_sales.bill_customer.id is null) THEN 1
ELSE 0
END) -> store_sales,
    sum(CASE WHEN (merged.store_sales.customer.id is null and merged.catalog_sales.bill_customer.id is not null) THEN 1
ELSE 0
END) -> catalog_sales,
    sum(CASE WHEN (merged.store_sales.customer.id is not null and merged.catalog_sales.bill_customer.id is not null) THEN 1
ELSE 0
END) -> both_sales,
;